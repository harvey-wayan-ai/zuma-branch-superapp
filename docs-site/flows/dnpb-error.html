<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNPB Error Resolution - Zuma RO PWA</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="../styles.css">
</head>
<body class="flow-page">
    <div class="flow-container">
        <header class="flow-header">
            <a href="../index.html" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Overview
            </a>
            <h1>DNPB Error Resolution Flow (v1.2.6)</h1>
        </header>

        <div class="flow-content">
            <div class="mermaid">
flowchart TD
    Start([RO Arrives at Store]) --> Count[Store Staff Counts Physical Stock]
    Count --> Compare{Compare: Shipped vs Physical}
    
    Compare -->|Match| NoError[No DNPB Error]
    Compare -->|Differs| DNPBError[DNPB Error Tab]
    
    NoError --> AutoComplete[Status: COMPLETED]
    AutoComplete --> End1([End])
    
    DNPBError --> ShowDetails[Show Discrepancy Details]
    ShowDetails --> Decision{Banding or Confirmed?}
    
    Decision -->|Banding| BandingAction[BANDING Action]
    Decision -->|Confirmed| ConfirmedAction[CONFIRMED Action]
    
    BandingAction --> InsertNotice[Insert ro_banding_notices]
    InsertNotice --> SetPending[status: PENDING]
    SetPending --> UpdateStatus[Update ro_process: BANDING_SENT]
    UpdateStatus --> Notify[Notify ro-arrive-app]
    Notify --> WaitReCheck[Wait for SPG/B Re-check]
    WaitReCheck --> Count
    
    ConfirmedAction --> FetchReceipt[Fetch ro_receipt Data]
    FetchReceipt --> Calc[Calculate New Allocations]
    Calc --> UpdateProcess[Update ro_process]
    UpdateProcess --> SetCompleted[status: COMPLETED]
    SetCompleted --> UpdateReceipt[Update ro_receipt]
    UpdateReceipt --> SetConfirmed[status: CONFIRMED_DISCREPANCY]
    SetConfirmed --> RODone[RO Resolved]
    RODone --> End2([End])
    
    style Start fill:#0D3B2E,stroke:#00D084,color:#fff
    style End1 fill:#0D3B2E,stroke:#00D084,color:#fff
    style End2 fill:#0D3B2E,stroke:#00D084,color:#fff
    style NoError fill:#dcfce7,stroke:#16a34a,stroke-width:2px
    style DNPBError fill:#fee2e2,stroke:#dc2626,stroke-width:2px
    style BandingAction fill:#ffedd5,stroke:#ea580c,stroke-width:2px
    style ConfirmedAction fill:#0D3B2E,stroke:#00D084,color:#fff,stroke-width:2px
    style AutoComplete fill:#dcfce7,stroke:#16a34a,stroke-width:2px
    style RODone fill:#dcfce7,stroke:#16a34a,stroke-width:2px
            </div>
        </div>

        <div class="flow-explanation">
            <h2>Banding vs Confirmed Comparison</h2>
            <table style="width:100%;border-collapse:collapse;margin-top:1rem;">
                <tr style="background:#0D3B2E;color:white;">
                    <th style="padding:12px;text-align:left;">Aspect</th>
                    <th style="padding:12px;text-align:left;background:#ffedd5;color:#ea580c;">BANDING (Orange)</th>
                    <th style="padding:12px;text-align:left;background:#dcfce7;color:#16a34a;">CONFIRMED (Green)</th>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;"><strong>RO Status</strong></td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#fff7ed;">BANDING_SENT</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#f0fdf4;">Changed to COMPLETED</td>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;"><strong>Database Action</strong></td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#fff7ed;">Insert to ro_banding_notices</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#f0fdf4;">Update ro_process + ro_receipt</td>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;"><strong>Stock Impact</strong></td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#fff7ed;">No change</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#f0fdf4;">Adjusted to fisik quantities</td>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;"><strong>Purpose</strong></td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#fff7ed;">Dispute/Investigation</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#f0fdf4;">Accept discrepancy and close</td>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;"><strong>Notification</strong></td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#fff7ed;">Sent to ro-arrive-app</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#f0fdf4;">None (internal resolution)</td>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;"><strong>Next Step</strong></td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#fff7ed;">Wait for ro-arrive-app re-check</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;background:#f0fdf4;">RO complete - no further action</td>
                </tr>
            </table>

            <h2 style="margin-top:2rem;">Box Allocation Calculation (Confirmed)</h2>
            <pre style="background:#f4f4f4;padding:1rem;border-radius:8px;overflow-x:auto;">
// 1. Calculate total boxes from fisik (physical received)
const fisikBoxes = Math.ceil(item.fisik / item.pairs_per_box)

// 2. Calculate DDD/LJBB split based on original ratio
const totalOriginalBoxes = item.boxes_ddd + item.boxes_ljbb
let dddBoxes = 0
let ljbbBoxes = 0

if (totalOriginalBoxes > 0) {
  const dddRatio = item.boxes_ddd / totalOriginalBoxes
  dddBoxes = Math.round(fisikBoxes * dddRatio)
  ljbbBoxes = fisikBoxes - dddBoxes
}

// 3. Update ro_process with new allocations
UPDATE ro_process 
SET 
  status = 'COMPLETED',
  boxes_allocated_ddd = dddBoxes,
  boxes_allocated_ljbb = ljbbBoxes,
  updated_at = NOW()
WHERE ro_id = ? AND article_code = ?
            </pre>

            <h2 style="margin-top:2rem;">API Endpoint</h2>
            <pre style="background:#f4f4f4;padding:1rem;border-radius:8px;overflow-x:auto;">
POST /api/ro/banding
{
  "ro_id": "RO-2502-0001",
  "action": "BANDING" | "CONFIRMED"
}

// BANDING Response:
{
  "success": true,
  "message": "Banding notice created successfully"
}

// CONFIRMED Response:
{
  "success": true,
  "message": "Discrepancy confirmed - RO marked as COMPLETED with actual received quantities"
}
            </pre>

            <h2 style="margin-top:2rem;">ro_banding_notices Schema</h2>
            <table style="width:100%;border-collapse:collapse;margin-top:1rem;">
                <tr style="background:#0D3B2E;color:white;">
                    <th style="padding:12px;text-align:left;">Column</th>
                    <th style="padding:12px;text-align:left;">Type</th>
                    <th style="padding:12px;text-align:left;">Description</th>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">id</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">UUID</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">Primary key</td>
                </tr>
                <tr style="background:#f9fafb;">
                    <td style="padding:12px;border-bottom:1px solid #ddd;">ro_id</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">VARCHAR(50)</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">RO ID reference</td>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">banding_by</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">UUID</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">User who created banding</td>
                </tr>
                <tr style="background:#f9fafb;">
                    <td style="padding:12px;border-bottom:1px solid #ddd;">banding_at</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">TIMESTAMP</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">When banding was created</td>
                </tr>
                <tr>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">status</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">VARCHAR(20)</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">PENDING (default)</td>
                </tr>
                <tr style="background:#f9fafb;">
                    <td style="padding:12px;border-bottom:1px solid #ddd;">message</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">TEXT</td>
                    <td style="padding:12px;border-bottom:1px solid #ddd;">Fixed message about discrepancy</td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
